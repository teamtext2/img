<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- SEO Meta Tags -->
  <title>Text2 - Img Design </title>
  <meta name="description" content="Text2 Img Design - Free AI-powered image design tool. Edit PSD, PNG, JPG files online with professional tools. Create stunning designs with our advanced image editor.">
  <meta name="keywords" content="Text2 Img Design, Img Design, AI Image Design, Online Image Editor, PSD Editor, Photo Editor, Design Tool, Free Image Design, Text2 Design">
  <meta name="author" content="Text2">
  <meta name="robots" content="index, follow">
  
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="Text2 - Img Design | AI Image Design Tool">
  <meta property="og:description" content="Free AI-powered image design tool. Edit PSD, PNG, JPG files online with professional tools.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://img.text2.click">
  <meta property="og:image" content="https://img.text2.click/logoc.png">
  <meta property="og:image:width" content="512">
  <meta property="og:image:height" content="512">
  <meta property="og:image:alt" content="Text2 Img Design Logo">
  <meta property="og:site_name" content="Text2 Img Design">
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Text2 - Img Design | AI Image Design Tool">
  <meta name="twitter:description" content="Free AI-powered image design tool. Edit PSD, PNG, JPG files online with professional tools.">
  <meta name="twitter:image" content="https://img.text2.click/logoc.png">
  <meta name="twitter:image:alt" content="Text2 Img Design Logo">
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://img.text2.click">
  
  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  
  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Text2 Img Design",
    "description": "Free AI-powered image design tool for editing PSD, PNG, JPG files online",
    "url": "https://img.text2.click",
    "applicationCategory": "DesignApplication",
    "operatingSystem": "Web Browser",
    "logo": "https://img.text2.click/logoc.png",
    "image": "https://img.text2.click/logoc.png",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "creator": {
      "@type": "Organization",
      "name": "Text2",
      "url": "https://text2.click",
      "logo": "https://img.text2.click/logoc.png"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Text2",
      "logo": "https://img.text2.click/logoc.png"
    }
  }
  </script>

  <!-- Google tag (gtag.js) - GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ABCDEFG123"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-6J85STMJ14');
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'dark-bg': '#121212',
            'dark-bg-alt': '#1A1A1A',
            'dark-surface': '#1E1E1E',
            'dark-surface-alt': '#242424',
            'dark-text': '#FFFFFF',
            'dark-text-muted': '#B0B0B0',
            'accent-blue': '#1E90FF',
            'accent-blue-dark': '#1976D2'
          }
        }
      }
    }
  </script>
</head>
<body class="bg-dark-bg font-sans min-h-screen flex flex-col text-dark-text">
  <!-- Header -->
  <header class="bg-dark-surface shadow-lg w-full sticky top-0 z-50 border-b border-dark-surface-alt">
    <div class="max-w-6xl mx-auto flex items-center py-3 px-4">
      <a href="https://text2.click" class="flex items-center gap-3">
        <img src="https://img.text2.click/favicon.ico" alt="Text2 Img Design logo" class="w-8 h-8 md:w-10 md:h-10 rounded shadow-lg" />
        <span class="text-xl md:text-2xl font-bold text-accent-blue tracking-wide">Text2</span>
      </a>
      <span class="ml-2 md:ml-4 text-dark-text-muted text-sm md:text-lg font-semibold hidden sm:block">| Img Design - design your photo</span>
    </div>
  </header>

  <main class="flex-1 flex flex-col items-center justify-center py-4 md:py-8 px-2" id="mainContent">

    <!-- Upload interface -->
    <div id="uploadSection" class="bg-dark-surface p-4 md:p-8 rounded-2xl shadow-2xl w-full max-w-xl text-center border border-dark-surface-alt">
      <label class="block text-base md:text-lg font-semibold mb-2 text-dark-text">üìÇ Select a PSD / PNG / JPG image file from your device:</label>
      <input id="fileInput" type="file" accept=".psd,.png,.jpg,.jpeg,.webp" class="mb-4 block w-full text-dark-text bg-dark-bg border border-dark-surface-alt rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-accent-blue text-sm md:text-base">
      
      <button onclick="uploadToPhotopea()" class="w-full bg-accent-blue text-dark-text font-bold py-2 px-4 rounded-lg hover:bg-accent-blue-dark transition text-sm md:text-base shadow-lg">Start Designing with Text2 Img Design</button>
      
      <!-- Mobile warning -->
      <div id="mobileWarning" class="mt-4 p-3 bg-dark-surface-alt border border-accent-blue/30 rounded-lg text-dark-text-muted text-sm hidden">
        <p class="font-semibold text-accent-blue">üì± Mobile Device Detected</p>
        <p>For best experience, ensure stable internet connection and use files under 50MB.</p>
      </div>
    </div>

    <!-- Fullscreen app interface after upload -->
    <div id="photopeaApp" class="hidden fixed inset-0 z-50 flex flex-col bg-dark-bg">
      <!-- Toolbar -->
      <div class="flex items-center justify-between bg-dark-surface px-2 md:px-4 py-2 shadow-lg border-b border-dark-surface-alt">
        <div class="flex items-center gap-2">
          <a href="https://text2.click" target="_blank" class="flex items-center gap-2">
            <img src="https://img.text2.click/favicon.ico" alt="Text2 Img Design logo" class="w-6 h-6 md:w-8 md:h-8 rounded shadow-lg" />
            <span class="text-accent-blue text-lg md:text-xl font-bold tracking-wide">Text2</span>
          </a>
        </div>
        <div class="flex items-center gap-1 md:gap-2">
          <button onclick="addImageToPhotopea()" class="bg-dark-text text-dark-bg font-semibold px-2 md:px-3 py-1 rounded hover:bg-dark-text-muted transition flex items-center gap-1 text-xs md:text-sm"><span>‚ûï</span> <span class="hidden sm:inline">Add Image</span></button>
          <button id="btnQuickExport" onclick="exportPngQuick()" class="hidden bg-green-600 text-dark-text font-bold px-2 md:px-3 py-1 rounded hover:bg-green-700 transition text-xs md:text-sm">‚¨á <span class="hidden sm:inline">Xu·∫•t PNG nhanh</span></button>
          <button onclick="closePhotopeaApp()" class="bg-red-600 text-dark-text font-bold px-2 md:px-3 py-1 rounded hover:bg-red-700 transition ml-1 md:ml-2 text-xs md:text-sm">‚úñ <span class="hidden sm:inline">Close</span></button>
        </div>
      </div>
      <!-- Mobile-specific interface -->
      <div id="mobileInterface" class="md:hidden flex flex-col flex-1">
        <div class="flex-1 flex items-center justify-center bg-dark-bg-alt">
          <div class="text-center p-6">
            <div class="text-6xl mb-4">üì±</div>
            <h3 class="text-xl font-semibold mb-2 text-dark-text">Mobile Editor</h3>
            <p class="text-dark-text-muted mb-4">For the best editing experience on mobile, we recommend:</p>
            <div class="space-y-2 text-sm text-dark-text-muted">
              <p>‚Ä¢ Use desktop version for complex editing</p>
              <p>‚Ä¢ Ensure stable internet connection</p>
              <p>‚Ä¢ Try landscape orientation</p>
            </div>
            <button onclick="openPhotopeaInApp()" class="mt-4 bg-accent-blue text-dark-text px-4 py-2 rounded-lg hover:bg-accent-blue-dark transition shadow-lg">
              Open Editor
            </button>
          </div>
        </div>
      </div>
      
      <!-- Desktop iframe interface -->
      <div id="desktopInterface" class="hidden md:flex flex-col flex-1">
        <div class="flex-1 relative">
          <iframe id="photopeaFrame" class="w-full h-full border-none bg-dark-bg" style="min-height: 70vh;" title="Text2 Img Design Editor"></iframe>
        </div>
      </div>
    </div>
  </main>

  <!-- Mobile-only notification banner (shown only on mobile, then we force desktop layout) -->
  <div id="mobileNotifyBanner" class="hidden fixed bottom-0 inset-x-0 z-[60]">
    <div class="mx-auto max-w-6xl px-3 pb-3">
      <div class="rounded-xl shadow-lg border border-accent-blue/30 bg-dark-surface/95 backdrop-blur p-3 flex items-start gap-3">
        <div class="text-2xl">üîî</div>
        <div class="flex-1">
          <p class="text-sm text-dark-text font-semibold mb-1">ƒêang d√πng thi·∫øt b·ªã di ƒë·ªông</p>
          <p class="text-xs text-dark-text-muted">ƒê√£ chuy·ªÉn sang ch·∫ø ƒë·ªô trang web d√†nh cho m√°y t√≠nh ƒë·ªÉ s·ª≠ d·ª•ng ƒë·∫ßy ƒë·ªß. B·∫≠t th√¥ng b√°o ƒë·ªÉ nh·∫≠n c·∫≠p nh·∫≠t khi x·ª≠ l√Ω ·∫£nh.</p>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnEnableNotify" class="bg-accent-blue text-dark-text text-xs font-bold px-3 py-2 rounded-lg hover:bg-accent-blue-dark shadow-lg">B·∫≠t th√¥ng b√°o</button>
          <button id="btnDismissNotify" class="text-xs text-dark-text-muted hover:text-dark-text">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-dark-surface border-t border-dark-surface-alt py-4 mt-8 shadow-inner">
    <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between px-4 text-dark-text-muted text-sm">
      <div class="flex items-center gap-2">
        <img src="https://img.text2.click/favicon.ico" alt="Text2 Img Design logo" class="w-6 h-6" />
        <span>¬© 2024 <a href="https://text2.click" class="text-accent-blue hover:underline font-semibold">Text2 Img Design</a>.Text2 Img Design is powered by Photopea.</span>
      </div>
      <div class="mt-2 md:mt-0">
        <a href="https://text2.click" class="hover:underline hover:text-accent-blue">Home</a> |
        <a href="mailto:support@text2.click" class="hover:underline hover:text-accent-blue">Contact</a>
      </div>
    </div>
  </footer>

  <script>
    // Global variables
    let globalCapabilities = null;
    const FORCE_DESKTOP_ON_MOBILE = true; // Force desktop layout for mobile devices
    let originalMobileDetection = null; // snapshot before forcing

    // Enhanced mobile detection with better device profiling
    function isMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
             window.innerWidth <= 768;
    }

    // Device capability detection
    function getDeviceCapabilities() {
      if (globalCapabilities) return globalCapabilities;
      
      const detectedMobile = isMobile();
      originalMobileDetection = detectedMobile;

      const forcedMobileFlag = FORCE_DESKTOP_ON_MOBILE && detectedMobile;

      globalCapabilities = {
        isMobile: forcedMobileFlag ? false : detectedMobile,
        hasTouch: 'ontouchstart' in window,
        hasServiceWorker: 'serviceWorker' in navigator,
        hasWebGL: (() => {
          try {
            const canvas = document.createElement('canvas');
            return !!(window.WebGLRenderingContext && 
              (canvas.getContext('webgl') || canvas.getContext('experimental-web-gl')));
          } catch (e) {
            return false;
          }
        })(),
        connectionType: (() => {
          const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
          return connection ? connection.effectiveType : 'unknown';
        })(),
        memory: navigator.deviceMemory || 'unknown',
        cores: navigator.hardwareConcurrency || 'unknown',
        forcedDesktop: forcedMobileFlag
      };
      
      console.log('Device capabilities:', globalCapabilities);
      return globalCapabilities;
    }

    // Enhanced debug logging with device context
    function logDebug(message, level = 'info') {
      const capabilities = getDeviceCapabilities();
      const timestamp = new Date().toISOString();
      const logMessage = `[${timestamp}] [${level.toUpperCase()}] [${capabilities.isMobile ? 'Mobile' : 'Desktop'}] ${message}`;
      
      console.log(logMessage);
      
      // Store logs for debugging
      if (!window.debugLogs) window.debugLogs = [];
      window.debugLogs.push(logMessage);
      
      // Keep only last 100 logs
      if (window.debugLogs.length > 100) {
        window.debugLogs = window.debugLogs.slice(-100);
      }
    }

    // Enhanced network status checking with multiple fallbacks
    function checkNetworkStatus() {
      const status = {
        isOnline: navigator.onLine,
        connectionType: 'unknown',
        isStable: true,
        latency: null
      };

      // Check basic online status
      if (!status.isOnline) {
        logDebug('Device is offline', 'error');
        return Promise.resolve(status);
      }

      // Check connection type and quality
      const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      if (connection) {
        status.connectionType = connection.effectiveType;
        status.isStable = connection.effectiveType !== 'slow-2g' && connection.effectiveType !== '2g';
        logDebug(`Connection type: ${status.connectionType}, stable: ${status.isStable}`);
      }

      // Test actual connectivity with multiple endpoints
      return testConnectivity().then(connectivityResult => {
        Object.assign(status, connectivityResult);
        return status;
      }).catch(() => {
        logDebug('Connectivity test failed, using fallback status', 'warn');
        return status;
      });
    }

    // Test actual connectivity to multiple endpoints
    function testConnectivity() {
      const endpoints = [
        'https://www.google.com/favicon.ico',
        'https://www.cloudflare.com/favicon.ico',
        'https://www.photopea.com/favicon.ico'
      ];

      const tests = endpoints.map(endpoint => 
        fetch(endpoint, { 
          method: 'HEAD', 
          mode: 'no-cors',
          cache: 'no-cache'
        }).then(() => ({ endpoint, success: true }))
        .catch(() => ({ endpoint, success: false }))
      );

      return Promise.race([
        Promise.allSettled(tests),
        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 10000))
      ]).then(results => {
        const successfulTests = results.filter(r => r.status === 'fulfilled' && r.value.success).length;
        const successRate = successfulTests / endpoints.length;
        
        return {
          connectivityTest: successRate > 0.5,
          successRate: successRate,
          latency: Date.now() // Simple latency measurement
        };
      });
    }

    // Enhanced Photopea accessibility check with retry mechanism
    function checkPhotopeaAccess(maxRetries = 3) {
      return new Promise((resolve) => {
        let attempts = 0;
        
        const attemptConnection = () => {
          attempts++;
          logDebug(`Photopea access check attempt ${attempts}/${maxRetries}`);
          
          const testIframe = document.createElement('iframe');
          testIframe.style.display = 'none';
          testIframe.src = 'https://www.photopea.com';
          
          const timeout = setTimeout(() => {
            if (document.body.contains(testIframe)) {
              document.body.removeChild(testIframe);
            }
            
            if (attempts < maxRetries) {
              logDebug(`Attempt ${attempts} failed, retrying...`, 'warn');
              setTimeout(attemptConnection, 1000 * attempts); // Exponential backoff
            } else {
              logDebug('All Photopea access attempts failed', 'error');
              resolve(false);
            }
          }, 5000);
          
          testIframe.onload = () => {
            clearTimeout(timeout);
            if (document.body.contains(testIframe)) {
              document.body.removeChild(testIframe);
            }
            logDebug(`Photopea access check successful on attempt ${attempts}`);
            resolve(true);
          };
          
          testIframe.onerror = () => {
            clearTimeout(timeout);
            if (document.body.contains(testIframe)) {
              document.body.removeChild(testIframe);
            }
            
            if (attempts < maxRetries) {
              logDebug(`Attempt ${attempts} failed, retrying...`, 'warn');
              setTimeout(attemptConnection, 1000 * attempts);
            } else {
              logDebug('All Photopea access attempts failed', 'error');
              resolve(false);
            }
          };
          
          document.body.appendChild(testIframe);
        };
        
        attemptConnection();
      });
    }

    // Enhanced file validation with better error handling
    function validateFile(file) {
      const errors = [];
      const capabilities = getDeviceCapabilities();
      
      // Check file existence
      if (!file) {
        errors.push('No file selected');
        return { valid: false, errors };
      }
      
      // Check file type
      const allowedTypes = ['.psd', '.png', '.jpg', '.jpeg', '.webp'];
      const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
      if (!allowedTypes.includes(fileExtension)) {
        errors.push(`File type ${fileExtension} not supported. Allowed: ${allowedTypes.join(', ')}`);
      }
      
      // File size check - no size limitations for desktop, reasonable limits for mobile
      // if (capabilities.isMobile && file.size > 100 * 1024 * 1024) { // 100MB limit for mobile
      //   errors.push('File size too large for mobile devices. Please use files under 100MB or try on desktop.');
      // }
      
      // Check if file is corrupted
      if (file.size === 0) {
        errors.push('File appears to be empty or corrupted');
      }
      
      return {
        valid: errors.length === 0,
        errors,
        fileExtension,
        fileSize: file.size,
        isMobile: capabilities.isMobile
      };
    }

    // Enhanced upload function with comprehensive error handling
    async function uploadToPhotopea() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      
      // Validate file first
      const validation = validateFile(file);
      if (!validation.valid) {
        alert(`File validation failed:\n${validation.errors.join('\n')}`);
        return;
      }

      logDebug(`Starting file upload: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`);

      // Show enhanced loading indicator
      const loadingDiv = createLoadingIndicator();
      document.body.appendChild(loadingDiv);

      try {
        // Step 1: Check network status
        updateLoadingStatus(loadingDiv, 'Checking network connection...');
        const networkStatus = await checkNetworkStatus();
        
        if (!networkStatus.isOnline) {
          throw new Error('Device is offline. Please check your internet connection.');
        }
        
        if (!networkStatus.connectivityTest) {
          throw new Error('Network connectivity test failed. Please check your connection and try again.');
        }

        // Step 2: Check Photopea accessibility with retry
        updateLoadingStatus(loadingDiv, 'Testing image editor accessibility...');
        const isAccessible = await checkPhotopeaAccess(3);
        
        if (!isAccessible) {
          if (validation.isMobile) {
            throw new Error('Image editor accessibility test failed on mobile. Please try:\n1. Use desktop version\n2. Check your internet connection\n3. Try a different browser');
          } else {
            throw new Error('Image editor accessibility test failed. Please check your internet connection and try again.');
          }
        }

        // Step 3: Read and process file
        updateLoadingStatus(loadingDiv, 'Processing image file...');
        const dataUrl = await readFileAsDataURL(file);
        // Cache session for restore later
        cacheLastSession(dataUrl);
        
        // Step 4: Prepare Photopea configuration
        updateLoadingStatus(loadingDiv, 'Preparing editor...');
        const config = {
          files: [dataUrl],
          script: 'app.echoToOE("Image loaded into Photopea successfully!");'
        };

        const encoded = encodeURIComponent(JSON.stringify(config));
        
        // Success - hide loading and show app
        loadingDiv.remove();
        document.getElementById('uploadSection').classList.add('hidden');
        document.getElementById('photopeaApp').classList.remove('hidden');
        
        // Show appropriate interface based on device
        const capabilities = getDeviceCapabilities();
        if (capabilities.isMobile) {
          // For mobile, show mobile interface
          document.getElementById('mobileInterface').classList.remove('hidden');
          document.getElementById('desktopInterface').classList.add('hidden');
          logDebug('Showing mobile interface');
        } else {
          // For desktop, load Photopea iframe
          document.getElementById('mobileInterface').classList.add('hidden');
          document.getElementById('desktopInterface').classList.remove('hidden');
          
          const iframe = document.getElementById('photopeaFrame');
          updateLoadingStatus(loadingDiv, 'Loading image editor...');
          await loadPhotopeaWithRetry(iframe, encoded, false);
          logDebug('Photopea loaded successfully on desktop');
        }
        
      } catch (error) {
        loadingDiv.remove();
        logDebug(`Upload failed: ${error.message}`, 'error');
        
        // Show user-friendly error message
        const errorMessage = getErrorMessage(error, validation);
        alert(errorMessage);
      }
    }

    // Create enhanced loading indicator
    function createLoadingIndicator() {
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'loading';
      loadingDiv.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
      loadingDiv.innerHTML = `
        <div class="bg-dark-surface p-6 rounded-lg text-center max-w-md mx-4 border border-dark-surface-alt shadow-2xl">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent-blue mx-auto mb-4"></div>
          <h3 class="text-lg font-semibold mb-2 text-dark-text">Loading Image Editor</h3>
          <p id="loadingStatus" class="text-dark-text-muted">Initializing...</p>
          <div class="mt-4 text-xs text-dark-text-muted">
            <p>This may take a moment on mobile devices</p>
            <p>Please ensure stable internet connection</p>
          </div>
        </div>
      `;
      return loadingDiv;
    }

    // Update loading status
    function updateLoadingStatus(loadingDiv, status) {
      const statusElement = loadingDiv.querySelector('#loadingStatus');
      if (statusElement) {
        statusElement.textContent = status;
      }
    }

    // Read file as data URL with error handling0
    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
          try {
            const dataUrl = e.target.result;
            logDebug(`File read successfully, size: ${dataUrl.length} characters`);
            resolve(dataUrl);
          } catch (error) {
            reject(new Error(`Failed to process file: ${error.message}`));
          }
        };
        
        reader.onerror = () => reject(new Error('Failed to read file. Please try again.'));
        reader.onabort = () => reject(new Error('File reading was aborted. Please try again.'));
        
        reader.readAsDataURL(file);
      });
    }

    // Load Photopea with retry mechanism
    function loadPhotopeaWithRetry(iframe, encoded, isMobile) {
      return new Promise((resolve, reject) => {
        const maxRetries = 3;
        let attempts = 0;
        
        const attemptLoad = () => {
          attempts++;
          logDebug(`Loading Photopea attempt ${attempts}/${maxRetries}`);
          
          const loadTimeout = setTimeout(() => {
            if (attempts < maxRetries) {
              logDebug(`Load timeout on attempt ${attempts}, retrying...`, 'warn');
              attemptLoad();
            } else {
              reject(new Error('Loading timeout after all retries. Please try again.'));
            }
          }, isMobile ? 30000 : 15000);
          
          iframe.onload = () => {
            clearTimeout(loadTimeout);
            logDebug('Photopea iframe loaded successfully');
            // Mark editor ready, show quick export
            window.photopeaReady = true;
            const btnQE = document.getElementById('btnQuickExport');
            if (btnQE) btnQE.classList.remove('hidden');
            // Try restore last session
            tryRestoreLastSession();
            resolve();
          };
          
          iframe.onerror = () => {
            clearTimeout(loadTimeout);
            if (attempts < maxRetries) {
              logDebug(`Load error on attempt ${attempts}, retrying...`, 'warn');
              setTimeout(attemptLoad, 1000 * attempts);
            } else {
              reject(new Error('Failed to load image editor after all retries.'));
            }
          };
          
          iframe.src = "https://www.photopea.com#" + encoded;
        };
        
        attemptLoad();
      });
    }

    // Quick export PNG using Photopea API
    async function exportPngQuick() {
      try {
        const iframe = document.getElementById('photopeaFrame');
        if (!iframe || !iframe.contentWindow) throw new Error('Editor not ready');

        const requestId = 'qe-' + Date.now();
        const exportScript = `var doc = app.activeDocument; if (doc){var png = doc.saveToOE('png'); app.echoToOE('QE_DONE:'+png.length);}`;
        const message = { type: 'script', script: exportScript, requestId };

        const result = await postMessageAwaitResponse(iframe, message, 30000);
        // result will be echoed as text length; actual binary comes via onmessage with ArrayBuffer
      } catch (e) {
        logDebug('Quick export failed: ' + e.message, 'error');
        alert('Xu·∫•t PNG th·∫•t b·∫°i: ' + e.message);
      }
    }

    // PostMessage helper awaiting a one-time response
    function postMessageAwaitResponse(iframe, data, timeoutMs = 15000) {
      return new Promise((resolve, reject) => {
        let settled = false;
        const timer = setTimeout(() => {
          if (!settled) {
            settled = true;
            window.removeEventListener('message', onMsg);
            reject(new Error('Timeout ch·ªù ph·∫£n h·ªìi')); 
          }
        }, timeoutMs);

        function onMsg(ev) {
          // Accept messages from Photopea regardless of origin (Photopea posts with '*')
          if (!ev || !ev.data) return;
          const data = ev.data;
          // Handle binary export (ArrayBuffer) or text echoes
          if (data instanceof ArrayBuffer) {
            // Save binary and trigger download
            cacheLastExport(data, 'image/png');
            triggerDownload(data, 'export.png');
            resolve({ ok: true, binary: true });
            cleanup();
            return;
          }
          if (typeof data === 'string' && data.indexOf('QE_DONE:') === 0) {
            // Length info received; actual data should come as ArrayBuffer next
            return; 
          }
        }

        function cleanup() {
          if (settled) return;
          settled = true;
          clearTimeout(timer);
          window.removeEventListener('message', onMsg);
        }

        window.addEventListener('message', onMsg);
        iframe.contentWindow.postMessage(data, '*');
      });
    }

    // Trigger file download from ArrayBuffer
    function triggerDownload(arrayBuffer, filename) {
      const blob = new Blob([arrayBuffer], { type: 'image/png' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 2000);
    }

    // IndexedDB helpers for caching last work/export
    const IDB_NAME = 'text2-img-cache';
    const IDB_VERSION = 1;
    const IDB_STORE_EXPORT = 'exports';
    const IDB_STORE_SESSION = 'sessions';

    function openIDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(IDB_NAME, IDB_VERSION);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(IDB_STORE_EXPORT)) db.createObjectStore(IDB_STORE_EXPORT);
          if (!db.objectStoreNames.contains(IDB_STORE_SESSION)) db.createObjectStore(IDB_STORE_SESSION);
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function cacheLastExport(arrayBuffer, mime) {
      try {
        const db = await openIDB();
        const tx = db.transaction(IDB_STORE_EXPORT, 'readwrite');
        const store = tx.objectStore(IDB_STORE_EXPORT);
        store.put({ data: arrayBuffer, mime, time: Date.now() }, 'last');
        await tx.complete; // some browsers ignore; best-effort
        db.close && db.close();
      } catch (e) {
        logDebug('Cache export failed: ' + e.message, 'warn');
      }
    }

    async function getLastExport() {
      try {
        const db = await openIDB();
        return await new Promise((resolve, reject) => {
          const tx = db.transaction(IDB_STORE_EXPORT, 'readonly');
          const store = tx.objectStore(IDB_STORE_EXPORT);
          const req = store.get('last');
          req.onsuccess = () => { db.close && db.close(); resolve(req.result || null); };
          req.onerror = () => { db.close && db.close(); reject(req.error); };
        });
      } catch (e) { return null; }
    }

    // Cache and restore session: we store original uploaded file DataURL to reload
    async function cacheLastSession(dataUrl) {
      try {
        const db = await openIDB();
        const tx = db.transaction(IDB_STORE_SESSION, 'readwrite');
        tx.objectStore(IDB_STORE_SESSION).put({ dataUrl, time: Date.now() }, 'last');
        await tx.complete;
        db.close && db.close();
      } catch (e) {
        logDebug('Cache session failed: ' + e.message, 'warn');
      }
    }

    async function getLastSession() {
      try {
        const db = await openIDB();
        return await new Promise((resolve, reject) => {
          const tx = db.transaction(IDB_STORE_SESSION, 'readonly');
          const req = tx.objectStore(IDB_STORE_SESSION).get('last');
          req.onsuccess = () => { db.close && db.close(); resolve(req.result || null); };
          req.onerror = () => { db.close && db.close(); reject(req.error); };
        });
      } catch (e) { return null; }
    }

    async function tryRestoreLastSession() {
      const sess = await getLastSession();
      if (!sess || !sess.dataUrl) return;
      try {
        const iframe = document.getElementById('photopeaFrame');
        if (!iframe || !iframe.contentWindow) return;
        const script = `app.open('${sess.dataUrl}'); app.echoToOE('RESTORED');`;
        iframe.contentWindow.postMessage({ type: 'script', script }, '*');
        logDebug('Restored last session image into editor');
      } catch {}
    }

    // Get user-friendly error message
    function getErrorMessage(error, validation) {
      const baseMessage = error.message;
      
      if (validation.isMobile) {
        return `Mobile Error: ${baseMessage}\n\nTroubleshooting:\n1. Use files smaller than 100MB\n2. Ensure stable WiFi connection\n3. Try desktop version if issues persist\n4. Clear browser cache and try again`;
      } else {
        return `Error: ${baseMessage}\n\nTroubleshooting:\n1. Check internet connection\n2. Try refreshing the page\n3. Use a different browser\n4. Contact support if issue persists`;
      }
    }

    // Enhanced close function
    function closePhotopeaApp() {
      const iframe = document.getElementById('photopeaFrame');
      if (iframe) iframe.src = ""; // reset if iframe exists
      document.getElementById('uploadSection').classList.remove('hidden');
      document.getElementById('photopeaApp').classList.add('hidden');
      
      // Hide both interfaces
      document.getElementById('mobileInterface').classList.add('hidden');
      document.getElementById('desktopInterface').classList.add('hidden');
      
      logDebug('Photopea app closed');
      
      // Clear any stored data
      if (window.debugLogs) {
        window.debugLogs = [];
      }
    }

    // Function to open Photopea directly in the app for mobile users
    function openPhotopeaInApp() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];

      if (!file) {
        alert('Please select a file first');
        return;
      }

      // Read file and load into Photopea iframe
      const reader = new FileReader();
      reader.onload = function(e) {
        const dataUrl = e.target.result;
        const config = {
          files: [dataUrl],
          script: 'app.echoToOE("Image loaded into Photopea successfully!");'
        };

        // Cache session for restore later
        cacheLastSession(dataUrl);

        const encoded = encodeURIComponent(JSON.stringify(config));
        const iframe = document.getElementById('photopeaFrame');

        if (iframe) {
          iframe.src = "https://www.photopea.com#" + encoded;
          document.getElementById('uploadSection').classList.add('hidden');
          document.getElementById('photopeaApp').classList.remove('hidden');
          document.getElementById('mobileInterface').classList.remove('hidden');
          document.getElementById('desktopInterface').classList.add('hidden');
          // Mark ready and show quick export button for mobile load
          window.photopeaReady = true;
          const btnQE = document.getElementById('btnQuickExport');
          if (btnQE) btnQE.classList.remove('hidden');
          tryRestoreLastSession();
          logDebug('Loaded Photopea directly in app for mobile user');
        } else {
          alert('Failed to initialize editor. Please try again.');
        }
      };

      reader.readAsDataURL(file);
    }

    // Enhanced add image function with better error handling
    function addImageToPhotopea() {
      const capabilities = getDeviceCapabilities();
      
      if (capabilities.isMobile) {
        alert('Adding images is not supported on mobile. Please use the desktop version for full functionality.');
        return;
      }
      
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.psd,.png,.jpg,.jpeg,.webp';
      
      input.onchange = async function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Validate file
        const validation = validateFile(file);
        if (!validation.valid) {
          alert(`Cannot add image:\n${validation.errors.join('\n')}`);
          return;
        }
        
        logDebug(`Adding additional image: ${file.name}`);
        
        try {
          const dataUrl = await readFileAsDataURL(file);
          const script = `app.open('${dataUrl}');`;
          const message = {
            type: 'script',
            script: script
          };
          
          const iframe = document.getElementById('photopeaFrame');
          if (iframe && iframe.contentWindow) {
            iframe.contentWindow.postMessage(message, '*');
            logDebug('Sent add image message to Photopea');
          } else {
            throw new Error('Editor not ready');
          }
        } catch (error) {
          logDebug(`Error adding image: ${error.message}`, 'error');
          alert(`Failed to add image: ${error.message}`);
        }
      };
      
      input.click();
    }

    // Enhanced initialization with device optimization
    document.addEventListener('DOMContentLoaded', function() {
      const capabilities = getDeviceCapabilities();
      logDebug('Page initialized with device capabilities');
      
      // If mobile is detected and we force desktop, adjust viewport and show banner
      if (capabilities.forcedDesktop) {
        const viewport = document.querySelector('meta[name="viewport"]');
        if (viewport) {
          // Wider layout to emulate desktop on mobile
          viewport.setAttribute('content', 'width=1200, initial-scale=0.7');
        }

        // Show mobile notification banner (only first visit in this session)
        const bannerSeen = sessionStorage.getItem('mobileNotifyBannerSeen');
        const banner = document.getElementById('mobileNotifyBanner');
        if (banner && !bannerSeen) {
          banner.classList.remove('hidden');
        }

        const btnDismiss = document.getElementById('btnDismissNotify');
        if (btnDismiss) {
          btnDismiss.addEventListener('click', () => {
            sessionStorage.setItem('mobileNotifyBannerSeen', '1');
            banner.classList.add('hidden');
          });
        }

        const btnEnable = document.getElementById('btnEnableNotify');
        if (btnEnable) {
          btnEnable.addEventListener('click', async () => {
            try {
              if (!('Notification' in window)) {
                alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ th√¥ng b√°o.');
                return;
              }

              const permission = await Notification.requestPermission();
              if (permission !== 'granted') {
                alert('B·∫°n ƒë√£ t·ª´ ch·ªëi b·∫≠t th√¥ng b√°o.');
                return;
              }

              if ('serviceWorker' in navigator) {
                try {
                  const reg = await navigator.serviceWorker.register('/sw.js');
                  await reg.update();
                  // Test notification
                  if (reg.showNotification) {
                    reg.showNotification('Text2 Img Design', {
                      body: 'Th√¥ng b√°o ƒë√£ ƒë∆∞·ª£c b·∫≠t tr√™n thi·∫øt b·ªã di ƒë·ªông.',
                      icon: '/android-chrome-192x192.png',
                      badge: '/favicon-32x32.png'
                    });
                  } else {
                    new Notification('Text2 Img Design', { body: 'Th√¥ng b√°o ƒë√£ ƒë∆∞·ª£c b·∫≠t.' });
                  }
                } catch (e) {
                  logDebug('Service worker registration failed: ' + e.message, 'error');
                  new Notification('Text2 Img Design', { body: 'Th√¥ng b√°o ƒë∆∞·ª£c b·∫≠t, nh∆∞ng kh√¥ng th·ªÉ ƒëƒÉng k√Ω SW.' });
                }
              }

              sessionStorage.setItem('mobileNotifyBannerSeen', '1');
              banner.classList.add('hidden');
            } catch (e) {
              logDebug('Enable notification error: ' + e.message, 'error');
            }
          });
        }
      }

      if (capabilities.isMobile) {
        // Show mobile warning
        const mobileWarning = document.getElementById('mobileWarning');
        if (mobileWarning) {
          mobileWarning.classList.remove('hidden');
        }
        
        // Add mobile-specific optimizations
        const fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', function() {
          const file = this.files[0];
          if (file) {
            const validation = validateFile(file);
            logDebug(`File selected: ${file.name}, validation: ${validation.valid}`);
            
            if (!validation.valid) {
              alert(`File issue detected:\n${validation.errors.join('\n')}`);
              this.value = ''; // Clear invalid file
            }
          }
        });
        
        // Add touch event handling for better mobile UX
        const uploadButton = document.querySelector('button[onclick="uploadToPhotopea()"]');
        if (uploadButton) {
          uploadButton.addEventListener('touchstart', function() {
            this.style.transform = 'scale(0.98)';
          });
          uploadButton.addEventListener('touchend', function() {
            this.style.transform = 'scale(1)';
          });
        }
      }
      
      // Add global error handler
      window.addEventListener('error', function(event) {
        logDebug(`Global error: ${event.error?.message || event.message}`, 'error');
      });
      
      // Add unhandled promise rejection handler
      window.addEventListener('unhandledrejection', function(event) {
        logDebug(`Unhandled promise rejection: ${event.reason}`, 'error');
      });
      
      // Add network status change listener
      window.addEventListener('online', () => {
        logDebug('Device came online');
      });
      
      window.addEventListener('offline', () => {
        logDebug('Device went offline', 'warn');
      });
    });

    // Add debug function for troubleshooting
    window.debugText2Img = function() {
      const capabilities = getDeviceCapabilities();
      const logs = window.debugLogs || [];
      
      console.group('Text2 Img Design Debug Info');
      console.log('Device Capabilities:', capabilities);
      console.log('Debug Logs:', logs);
      console.log('Current Network Status:', navigator.onLine);
      console.log('User Agent:', navigator.userAgent);
      console.groupEnd();
      
      return { capabilities, logs, networkStatus: navigator.onLine };
    };
  </script>
</body>
</html>


