<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- SEO Meta Tags -->
  <title>Text2 - Img Design </title>
  <meta name="description" content="Text2 Img Design - Free AI-powered image design tool. Edit PSD, PNG, JPG files online with professional tools. Create stunning designs with our advanced image editor.">
  <meta name="keywords" content="Text2 Img Design, Img Design, AI Image Design, Online Image Editor, PSD Editor, Photo Editor, Design Tool, Free Image Design, Text2 Design">
  <meta name="author" content="Text2">
  <meta name="robots" content="index, follow">
  
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="Text2 - Img Design | AI Image Design Tool">
  <meta property="og:description" content="Free AI-powered image design tool. Edit PSD, PNG, JPG files online with professional tools.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://img.text2.click">
  <meta property="og:image" content="https://img.text2.click/logoc.png">
  <meta property="og:image:width" content="512">
  <meta property="og:image:height" content="512">
  <meta property="og:image:alt" content="Text2 Img Design Logo">
  <meta property="og:site_name" content="Text2 Img Design">
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Text2 - Img Design | AI Image Design Tool">
  <meta name="twitter:description" content="Free AI-powered image design tool. Edit PSD, PNG, JPG files online with professional tools.">
  <meta name="twitter:image" content="https://img.text2.click/logoc.png">
  <meta name="twitter:image:alt" content="Text2 Img Design Logo">
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://img.text2.click">
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="https://img.text2.click/favicon.ico">
  <link rel="shortcut icon" type="image/x-icon" href="https://img.text2.click/favicon.ico">
  <link rel="apple-touch-icon" href="https://img.text2.click/favicon.ico">
  
  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Text2 Img Design",
    "description": "Free AI-powered image design tool for editing PSD, PNG, JPG files online",
    "url": "https://img.text2.click",
    "applicationCategory": "DesignApplication",
    "operatingSystem": "Web Browser",
    "logo": "https://img.text2.click/logoc.png",
    "image": "https://img.text2.click/logoc.png",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "creator": {
      "@type": "Organization",
      "name": "Text2",
      "url": "https://text2.click",
      "logo": "https://img.text2.click/logoc.png"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Text2",
      "logo": "https://img.text2.click/logoc.png"
    }
  }
  </script>

  <!-- Google tag (gtag.js) - GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ABCDEFG123"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-6J85STMJ14');
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white shadow-md w-full sticky top-0 z-50">
    <div class="max-w-6xl mx-auto flex items-center py-3 px-4">
      <a href="https://text2.click" class="flex items-center gap-3">
        <img src="https://img.text2.click/favicon.ico" alt="Text2 Img Design logo" class="w-8 h-8 md:w-10 md:h-10 rounded shadow" />
        <span class="text-xl md:text-2xl font-bold text-indigo-700 tracking-wide">Text2</span>
      </a>
      <span class="ml-2 md:ml-4 text-gray-500 text-sm md:text-lg font-semibold hidden sm:block">| Img Design - design your photo</span>
    </div>
  </header>

  <main class="flex-1 flex flex-col items-center justify-center py-4 md:py-8 px-2" id="mainContent">

    <!-- Upload interface -->
    <div id="uploadSection" class="bg-white p-4 md:p-8 rounded-2xl shadow-xl w-full max-w-xl text-center border border-indigo-100">
      <label class="block text-base md:text-lg font-semibold mb-2">ðŸ“‚ Select a PSD / PNG / JPG image file from your device:</label>
      <input id="fileInput" type="file" accept=".psd,.png,.jpg,.jpeg,.webp" class="mb-4 block w-full text-gray-800 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-400 text-sm md:text-base">
      
      <button onclick="uploadToPhotopea()" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition text-sm md:text-base">Start Designing with Text2 Img Design</button>
      
    <!-- Fullscreen app interface after upload -->
    <div id="photopeaApp" class="hidden fixed inset-0 z-50 flex flex-col bg-white">
      <!-- Toolbar -->
      <div class="flex items-center justify-between bg-indigo-700 px-2 md:px-4 py-2 shadow-lg">
        <div class="flex items-center gap-2">
          <a href="https://text2.click" target="_blank" class="flex items-center gap-2">
            <img src="https://img.text2.click/favicon.ico" alt="Text2 Img Design logo" class="w-6 h-6 md:w-8 md:h-8 rounded" />
            <span class="text-white text-lg md:text-xl font-bold tracking-wide">Text2</span>
          </a>
        </div>
        <div class="flex items-center gap-1 md:gap-2">
          <button onclick="addImageToPhotopea()" class="bg-white text-indigo-700 font-semibold px-2 md:px-3 py-1 rounded hover:bg-indigo-100 transition flex items-center gap-1 text-xs md:text-sm"><span>âž•</span> <span class="hidden sm:inline">Add Image</span></button>
          <button onclick="closePhotopeaApp()" class="bg-red-500 text-white font-bold px-2 md:px-3 py-1 rounded hover:bg-red-600 transition ml-1 md:ml-2 text-xs md:text-sm">âœ– <span class="hidden sm:inline">Close</span></button>
        </div>
      </div>
      <!-- Photopea iframe -->
      <div class="flex-1 relative">
        <iframe id="photopeaFrame" class="w-full h-full border-none" style="min-height: 70vh;" title="Text2 Img Design Editor"></iframe>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t border-indigo-100 py-4 mt-8 shadow-inner">
    <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between px-4 text-gray-500 text-sm">
      <div class="flex items-center gap-2">
        <img src="https://img.text2.click/favicon.ico" alt="Text2 Img Design logo" class="w-6 h-6" />
        <span>Â© 2024 <a href="https://text2.click" class="text-indigo-600 hover:underline font-semibold">Text2 Img Design</a>.Text2 Img Design is powered by Photopea.</span>
      </div>
      <div class="mt-2 md:mt-0">
        <a href="https://text2.click" class="hover:underline">Home</a> |
        <a href="mailto:support@text2.click" class="hover:underline">Contact</a>
      </div>
    </div>
  </footer>

  <script>
    // Enhanced mobile detection with better device profiling
    function isMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
             window.innerWidth <= 768;
    }

    // Device capability detection
    function getDeviceCapabilities() {
      const capabilities = {
        isMobile: isMobile(),
        hasTouch: 'ontouchstart' in window,
        hasServiceWorker: 'serviceWorker' in navigator,
        hasWebGL: (() => {
          try {
            const canvas = document.createElement('canvas');
            return !!(window.WebGLRenderingContext && 
              (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));
          } catch (e) {
            return false;
          }
        })(),
        connectionType: (() => {
          const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
          return connection ? connection.effectiveType : 'unknown';
        })(),
        memory: navigator.deviceMemory || 'unknown',
        cores: navigator.hardwareConcurrency || 'unknown'
      };
      
      console.log('Device capabilities:', capabilities);
      return capabilities;
    }

    // Enhanced debug logging with device context
    function logDebug(message, level = 'info') {
      const capabilities = getDeviceCapabilities();
      const timestamp = new Date().toISOString();
      const logMessage = `[${timestamp}] [${level.toUpperCase()}] [${capabilities.isMobile ? 'Mobile' : 'Desktop'}] ${message}`;
      
      console.log(logMessage);
      
      // Store logs for debugging
      if (!window.debugLogs) window.debugLogs = [];
      window.debugLogs.push(logMessage);
      
      // Keep only last 100 logs
      if (window.debugLogs.length > 100) {
        window.debugLogs = window.debugLogs.slice(-100);
      }
    }

    // Enhanced network status checking with multiple fallbacks
    function checkNetworkStatus() {
      const status = {
        isOnline: navigator.onLine,
        connectionType: 'unknown',
        isStable: true,
        latency: null
      };

      // Check basic online status
      if (!status.isOnline) {
        logDebug('Device is offline', 'error');
        return status;
      }

      // Check connection type and quality
      const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      if (connection) {
        status.connectionType = connection.effectiveType;
        status.isStable = connection.effectiveType !== 'slow-2g' && connection.effectiveType !== '2g';
        logDebug(`Connection type: ${status.connectionType}, stable: ${status.isStable}`);
      }

      // Test actual connectivity with multiple endpoints
      return testConnectivity().then(connectivityResult => {
        Object.assign(status, connectivityResult);
        return status;
      }).catch(() => {
        logDebug('Connectivity test failed, using fallback status', 'warn');
        return status;
      });
    }

    // Test actual connectivity to multiple endpoints
    function testConnectivity() {
      const endpoints = [
        'https://www.google.com/favicon.ico',
        'https://www.cloudflare.com/favicon.ico',
        'https://www.photopea.com/favicon.ico'
      ];

      const tests = endpoints.map(endpoint => 
        fetch(endpoint, { 
          method: 'HEAD', 
          mode: 'no-cors',
          cache: 'no-cache',
          timeout: 5000
        }).then(() => ({ endpoint, success: true }))
        .catch(() => ({ endpoint, success: false }))
      );

      return Promise.race([
        Promise.allSettled(tests),
        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 10000))
      ]).then(results => {
        const successfulTests = results.filter(r => r.status === 'fulfilled' && r.value.success).length;
        const successRate = successfulTests / endpoints.length;
        
        return {
          connectivityTest: successRate > 0.5,
          successRate: successRate,
          latency: Date.now() // Simple latency measurement
        };
      });
    }

    // Enhanced Photopea accessibility check with retry mechanism
    function checkPhotopeaAccess(maxRetries = 3) {
      return new Promise((resolve) => {
        let attempts = 0;
        
        const attemptConnection = () => {
          attempts++;
          logDebug(`Photopea access check attempt ${attempts}/${maxRetries}`);
          
          const testIframe = document.createElement('iframe');
          testIframe.style.display = 'none';
          testIframe.src = 'https://www.photopea.com';
          
          const timeout = setTimeout(() => {
            if (document.body.contains(testIframe)) {
              document.body.removeChild(testIframe);
            }
            
            if (attempts < maxRetries) {
              logDebug(`Attempt ${attempts} failed, retrying...`, 'warn');
              setTimeout(attemptConnection, 1000 * attempts); // Exponential backoff
            } else {
              logDebug('All Photopea access attempts failed', 'error');
              resolve(false);
            }
          }, 5000);
          
          testIframe.onload = () => {
            clearTimeout(timeout);
            if (document.body.contains(testIframe)) {
              document.body.removeChild(testIframe);
            }
            logDebug(`Photopea access check successful on attempt ${attempts}`);
            resolve(true);
          };
          
          testIframe.onerror = () => {
            clearTimeout(timeout);
            if (document.body.contains(testIframe)) {
              document.body.removeChild(testIframe);
            }
            
            if (attempts < maxRetries) {
              logDebug(`Attempt ${attempts} failed, retrying...`, 'warn');
              setTimeout(attemptConnection, 1000 * attempts);
            } else {
              logDebug('All Photopea access attempts failed', 'error');
              resolve(false);
            }
          };
          
          document.body.appendChild(testIframe);
        };
        
        attemptConnection();
      });
    }

    // Enhanced file validation with better error handling
    function validateFile(file) {
      const errors = [];
      
      // Check file existence
      if (!file) {
        errors.push('No file selected');
        return { valid: false, errors };
      }
      
      // Check file type
      const allowedTypes = ['.psd', '.png', '.jpg', '.jpeg', '.webp'];
      const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
      if (!allowedTypes.includes(fileExtension)) {
        errors.push(`File type ${fileExtension} not supported. Allowed: ${allowedTypes.join(', ')}`);
      }
      
      // Check file size with device-specific limits
      const capabilities = getDeviceCapabilities();
      const maxSize = capabilities.isMobile ? 10 * 1024 * 1024 : 50 * 1024 * 1024; // 10MB mobile, 50MB desktop
      if (file.size > maxSize) {
        errors.push(`File too large (${(file.size / 1024 / 1024).toFixed(1)}MB). Max: ${(maxSize / 1024 / 1024).toFixed(0)}MB`);
      }
      
      // Check if file is corrupted
      if (file.size === 0) {
        errors.push('File appears to be empty or corrupted');
      }
      
      return {
        valid: errors.length === 0,
        errors,
        fileExtension,
        fileSize: file.size,
        isMobile: capabilities.isMobile
      };
    }

    // Enhanced upload function with comprehensive error handling
    async function uploadToPhotopea() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      
      // Validate file first
      const validation = validateFile(file);
      if (!validation.valid) {
        alert(`File validation failed:\n${validation.errors.join('\n')}`);
        return;
      }

      logDebug(`Starting file upload: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`);

      // Show enhanced loading indicator
      const loadingDiv = createLoadingIndicator();
      document.body.appendChild(loadingDiv);

      try {
        // Step 1: Check network status
        updateLoadingStatus(loadingDiv, 'Checking network connection...');
        const networkStatus = await checkNetworkStatus();
        
        if (!networkStatus.isOnline) {
          throw new Error('Device is offline. Please check your internet connection.');
        }
        
        if (!networkStatus.connectivityTest) {
          throw new Error('Network connectivity test failed. Please check your connection and try again.');
        }

        // Step 2: Check Photopea accessibility with retry
        updateLoadingStatus(loadingDiv, 'Testing image editor accessibility...');
        const isAccessible = await checkPhotopeaAccess(3);
        
        if (!isAccessible) {
          if (validation.isMobile) {
            throw new Error('Image editor accessibility test failed on mobile. Please try:\n1. Use desktop version\n2. Check your internet connection\n3. Try a different browser');
          } else {
            throw new Error('Image editor accessibility test failed. Please check your internet connection and try again.');
          }
        }

        // Step 3: Read and process file
        updateLoadingStatus(loadingDiv, 'Processing image file...');
        const dataUrl = await readFileAsDataURL(file);
        
        // Step 4: Prepare Photopea configuration
        updateLoadingStatus(loadingDiv, 'Preparing editor...');
        const config = {
          files: [dataUrl],
          script: 'app.echoToOE("Image loaded into Photopea successfully!");'
        };

        const encoded = encodeURIComponent(JSON.stringify(config));
        const iframe = document.getElementById('photopeaFrame');
        
        // Step 5: Load Photopea with enhanced error handling
        updateLoadingStatus(loadingDiv, 'Loading image editor...');
        await loadPhotopeaWithRetry(iframe, encoded, validation.isMobile);
        
        // Success - hide loading and show app
        document.getElementById('loading').remove();
        document.getElementById('uploadSection').classList.add('hidden');
        document.getElementById('photopeaApp').classList.remove('hidden');
        
        logDebug('Photopea loaded successfully');
        
      } catch (error) {
        document.getElementById('loading').remove();
        logDebug(`Upload failed: ${error.message}`, 'error');
        
        // Show user-friendly error message
        const errorMessage = getErrorMessage(error, validation);
        alert(errorMessage);
      }
    }

    // Create enhanced loading indicator
    function createLoadingIndicator() {
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'loading';
      loadingDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      loadingDiv.innerHTML = `
        <div class="bg-white p-6 rounded-lg text-center max-w-md mx-4">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
          <h3 class="text-lg font-semibold mb-2">Loading Image Editor</h3>
          <p id="loadingStatus" class="text-gray-600">Initializing...</p>
          <div class="mt-4 text-xs text-gray-500">
            <p>This may take a moment on mobile devices</p>
            <p>Please ensure stable internet connection</p>
          </div>
        </div>
      `;
      return loadingDiv;
    }

    // Update loading status
    function updateLoadingStatus(loadingDiv, status) {
      const statusElement = loadingDiv.querySelector('#loadingStatus');
      if (statusElement) {
        statusElement.textContent = status;
      }
    }

    // Read file as data URL with error handling
    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
          try {
            const dataUrl = e.target.result;
            logDebug(`File read successfully, size: ${dataUrl.length} characters`);
            resolve(dataUrl);
          } catch (error) {
            reject(new Error(`Failed to process file: ${error.message}`));
          }
        };
        
        reader.onerror = () => reject(new Error('Failed to read file. Please try again.'));
        reader.onabort = () => reject(new Error('File reading was aborted. Please try again.'));
        
        reader.readAsDataURL(file);
      });
    }

    // Load Photopea with retry mechanism
    function loadPhotopeaWithRetry(iframe, encoded, isMobile) {
      return new Promise((resolve, reject) => {
        const maxRetries = 3;
        let attempts = 0;
        
        const attemptLoad = () => {
          attempts++;
          logDebug(`Loading Photopea attempt ${attempts}/${maxRetries}`);
          
          const loadTimeout = setTimeout(() => {
            if (attempts < maxRetries) {
              logDebug(`Load timeout on attempt ${attempts}, retrying...`, 'warn');
              attemptLoad();
            } else {
              reject(new Error('Loading timeout after all retries. Please try again.'));
            }
          }, isMobile ? 30000 : 15000);
          
          iframe.onload = () => {
            clearTimeout(loadTimeout);
            logDebug('Photopea iframe loaded successfully');
            resolve();
          };
          
          iframe.onerror = () => {
            clearTimeout(loadTimeout);
            if (attempts < maxRetries) {
              logDebug(`Load error on attempt ${attempts}, retrying...`, 'warn');
              setTimeout(attemptLoad, 1000 * attempts);
            } else {
              reject(new Error('Failed to load image editor after all retries.'));
            }
          };
          
          iframe.src = "https://www.photopea.com#" + encoded;
        };
        
        attemptLoad();
      });
    }

    // Get user-friendly error message
    function getErrorMessage(error, validation) {
      const baseMessage = error.message;
      
      if (validation.isMobile) {
        return `Mobile Error: ${baseMessage}\n\nTroubleshooting:\n1. Use files smaller than 10MB\n2. Ensure stable WiFi connection\n3. Try desktop version if issues persist\n4. Clear browser cache and try again`;
      } else {
        return `Error: ${baseMessage}\n\nTroubleshooting:\n1. Check internet connection\n2. Try refreshing the page\n3. Use a different browser\n4. Contact support if issue persists`;
      }
    }

    // Enhanced close function
    function closePhotopeaApp() {
      const iframe = document.getElementById('photopeaFrame');
      iframe.src = ""; // reset
      document.getElementById('uploadSection').classList.remove('hidden');
      document.getElementById('photopeaApp').classList.add('hidden');
      logDebug('Photopea app closed');
      
      // Clear any stored data
      if (window.debugLogs) {
        window.debugLogs = [];
      }
    }

    // Enhanced add image function with better error handling
    function addImageToPhotopea() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.psd,.png,.jpg,.jpeg,.webp';
      
      input.onchange = async function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Validate file
        const validation = validateFile(file);
        if (!validation.valid) {
          alert(`Cannot add image:\n${validation.errors.join('\n')}`);
          return;
        }
        
        logDebug(`Adding additional image: ${file.name}`);
        
        try {
          const dataUrl = await readFileAsDataURL(file);
          const script = `app.open('${dataUrl}');`;
          const message = {
            type: 'script',
            script: script
          };
          
          const iframe = document.getElementById('photopeaFrame');
          if (iframe.contentWindow) {
            iframe.contentWindow.postMessage(message, '*');
            logDebug('Sent add image message to Photopea');
          } else {
            throw new Error('Editor not ready');
          }
        } catch (error) {
          logDebug(`Error adding image: ${error.message}`, 'error');
          alert(`Failed to add image: ${error.message}`);
        }
      };
      
      input.click();
    }

    // Enhanced initialization with device optimization
    document.addEventListener('DOMContentLoaded', function() {
      const capabilities = getDeviceCapabilities();
      logDebug('Page initialized with device capabilities');
      
      if (capabilities.isMobile) {
        // Show mobile warning
        const mobileWarning = document.getElementById('mobileWarning');
        if (mobileWarning) {
          mobileWarning.classList.remove('hidden');
        }
        
        // Add mobile-specific optimizations
        const fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', function() {
          const file = this.files[0];
          if (file) {
            const validation = validateFile(file);
            logDebug(`File selected: ${file.name}, validation: ${validation.valid}`);
            
            if (!validation.valid) {
              alert(`File issue detected:\n${validation.errors.join('\n')}`);
              this.value = ''; // Clear invalid file
            } else if (file.size > 5 * 1024 * 1024) {
              alert("Large file detected on mobile. This may take longer to load. Consider using a smaller file for better performance.");
            }
          }
        });
        
        // Add touch event handling for better mobile UX
        const uploadButton = document.querySelector('button[onclick="uploadToPhotopea()"]');
        if (uploadButton) {
          uploadButton.addEventListener('touchstart', function() {
            this.style.transform = 'scale(0.98)';
          });
          uploadButton.addEventListener('touchend', function() {
            this.style.transform = 'scale(1)';
          });
        }
      }
      
      // Add global error handler
      window.addEventListener('error', function(event) {
        logDebug(`Global error: ${event.error?.message || event.message}`, 'error');
      });
      
      // Add unhandled promise rejection handler
      window.addEventListener('unhandledrejection', function(event) {
        logDebug(`Unhandled promise rejection: ${event.reason}`, 'error');
      });
      
      // Add network status change listener
      window.addEventListener('online', () => {
        logDebug('Device came online');
      });
      
      window.addEventListener('offline', () => {
        logDebug('Device went offline', 'warn');
      });
    });

    // Add debug function for troubleshooting
    window.debugText2Img = function() {
      const capabilities = getDeviceCapabilities();
      const logs = window.debugLogs || [];
      
      console.group('Text2 Img Design Debug Info');
      console.log('Device Capabilities:', capabilities);
      console.log('Debug Logs:', logs);
      console.log('Current Network Status:', navigator.onLine);
      console.log('User Agent:', navigator.userAgent);
      console.groupEnd();
      
      return { capabilities, logs, networkStatus: navigator.onLine };
    };
  </script>
</body>
</html>


